
{% extends "layouts/main.html" %}
{% block title %}
  ရုံး(ဌာန)အသုံးစရိတ်
{% endblock %}
{% load myanmar_nums %}
{% block content %}
<div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-lg max-w-12xl mx-auto transition-colors duration-300">
  <!-- Header -->
  <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-3">
    <h2 class="text-2xl font-semibold text-slate-800 dark:text-slate-100 flex items-center gap-2">
      <span>ရုံး(ဌာန)အသုံးစရိတ်</span>
    </h2>
    <div class="flex flex-wrap gap-3 items-center">
      <form id="filter-form" class="flex gap-2 items-center">
        <select id="month" name="month"
          class="border border-slate-300 dark:border-slate-700 rounded-lg px-2 py-1 bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-100 focus:ring-2 focus:ring-indigo-500 outline-none transition">
          <option value="all">လအားလုံး</option>
          {% for m,v in months %}
            <option value="{{ m }}">{{ v }}</option>
          {% endfor %}
        </select>

        <select id="year" name="year"
          class="border border-slate-300 dark:border-slate-700 rounded-lg px-2 py-1 bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-100 focus:ring-2 focus:ring-indigo-500 outline-none transition">
          <option value="all">နှစ်အားလုံး</option>
          {% for y in years %}
            <option value="{{ y }}">{{ y|mynum }}</option>
          {% endfor %}
        </select>

        <button type="button" id="pdf-export"
          class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-1.5 rounded-lg shadow transition duration-200 hover:shadow-md">
          PDF ထုတ်ရန်
        </button>
      </form>
    </div>
  </div>
  
  <!-- Table -->
  <form id="spending-form">{% csrf_token %}
    <div class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700 shadow-inner transition">
      <table class="min-w-full border-collapse">
        <thead class="bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200">
          <tr>
            <th class="p-2 text-center font-semibold">စဉ်</th>
            <th class="p-2 text-left">ပစ္စည်းအမျိုးအမည်</th>
            <th class="p-2 text-left">ပစ္စည်းအမျိုးအစား</th>
            <th class="p-2 text-center" colspan="2">အရီအတွက်</th>
            <!-- <th class="p-2 text-center">ယူနစ်</th> -->
            <th class="p-2 text-right">စျီးနှုန်း</th>
            <th class="p-2 text-center">ဌာန</th>
            <th class="p-2 text-center">လ</th>
            <th class="p-2 text-center">ခုနှစ်</th>
            <th class="p-2 text-right">ကျသင့်ငွီ</th>
            
            <th class="p-2 text-center">လုပ်ဆောင်မှုများ</th>
          </tr>
        </thead>
        <tbody id="spending-body" class="divide-y divide-slate-200 dark:divide-slate-700 bg-white dark:bg-slate-900 transition-colors duration-300"></tbody>
      </table>
    </div>
  </form>

  <!-- Summary -->
  <div id="summary-bar"
    class="mt-4 text-right text-lg font-semibold text-slate-800 dark:text-slate-100 border-t border-slate-200 dark:border-slate-700 pt-3">
    စုစုပေါင်း -  <span id="total-sum">0</span> ကျပ်
  </div>
</div>

<script>
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
const body = document.getElementById("spending-body");
const totalSumElem = document.getElementById("total-sum");
const monthSel = document.getElementById("month");
const yearSel = document.getElementById("year");

function esc(str) {
    if (str === null || str === undefined) return "";
    return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#x27;");
}

// မြန်မာလ dictionary
const myanmarMonths = {
  "01": "ဇန်နဝါရီ", "02": "ဖေဖော်ဝါရီ", "03": "မတ်ချ်", "04": "ဧပြီ",
  "05": "မေ", "06": "ဂျုန်", "07": "ဂျူလိုင်", "08": "သြဂတ်စ်",
  "09": "စပ်တမ်ဘာ", "10": "အောက်တိုဘာ", "11": "နိုဗမ်ဘာ", "12": "ဒီဇင်ဘာ"
};

// ဂဏန်းပြောင်း
function toMyanmarNumber(num) {
  const map = { "0": "၀", "1": "၁", "2": "၂", "3": "၃", "4": "၄", "5": "၅", "6": "၆", "7": "၇", "8": "၈", "9": "၉" };
  return String(num).split("").map(c => map[c] ?? c).join("");
}

function toMyanmarMonth(code) { return myanmarMonths[code] || code; }

// Load records
async function loadData() {
  const m = monthSel.value;
  const y = yearSel.value;
  const res = await fetch(`{% url 'spending-list-api' %}?month=${m}&year=${y}`);
  const data = await res.json();
  body.innerHTML = "";

  let total = 0;
  data.forEach((r, i) => {
    total += r.total_cost;
    appendRow(r, i + 1);
  });
  totalSumElem.textContent = toMyanmarNumber(total.toLocaleString());
  appendEmptyRow(data.length + 1);
}

// ADD EMPTY ROW
function appendEmptyRow(idx) {
  const tr = document.createElement("tr");
  tr.className = "hover:bg-slate-50 dark:hover:bg-slate-800/50 transition";

  const today = new Date();
  const currentMonth = String(today.getMonth() + 1).padStart(2, "0");
  const currentYear = today.getFullYear();

  const departments = {
    office: "ရုံး",
    set: "SET",
    het: "HET",
    training: "School"
  };

  const deptOpts = Object.entries(departments)
    .map(([v,l]) => `<option value="${esc(v)}" ${v==="office"?"selected":""}>${esc(l)}</option>`).join("");

  const monthOptions = Object.entries(myanmarMonths)
    .map(([k,v]) => `<option value="${esc(k)}" ${k===currentMonth?"selected":""}>${esc(v)}</option>`).join("");

  const yearOptions = Array.from({length:5},(_,i)=>currentYear-2+i)
    .map(y => `<option value="${y}" ${y===currentYear?"selected":""}>${toMyanmarNumber(y)}</option>`).join("");

  tr.innerHTML = `
    <td class="p-2 text-center">${toMyanmarNumber(idx)}</td>
    <td><input name="item_name" class="w-full dark:bg-slate-700 dark:text-white border rounded-lg px-2 py-1"></td>
    <td><input name="category" class="w-full dark:bg-slate-700 dark:text-white border rounded-lg px-2 py-1"></td>
    <td><input name="unit" value="ခု" class="dark:bg-slate-700 dark:text-white border rounded-lg w-20 text-center"></td>
    <td><input name="quantity" type="number" value="1" min="1" class="dark:bg-slate-700 dark:text-white border rounded-lg w-20 text-center"></td>
    <td><input name="estimated_cost" type="number" value="0" class="dark:bg-slate-700 dark:text-white border rounded-lg w-28 text-right"></td>

    <td><select name="department" class="dark:bg-slate-700 dark:text-white border rounded-lg px-2 py-1 w-full">${deptOpts}</select></td>
    <td><select name="month" class="dark:bg-slate-700 dark:text-white border rounded-lg px-2 py-1 w-full">${monthOptions}</select></td>
    <td><select name="year" class="dark:bg-slate-700 dark:text-white border rounded-lg px-2 py-1 w-full">${yearOptions}</select></td>

    <td class="text-right total-cell">၀</td>
    <td class="text-center"><button type="button" class="bg-green-600 text-white px-3 py-1 rounded save-btn">သိမ်းမည်</button></td>
  `;

  body.appendChild(tr);

  const qty = tr.querySelector('[name="quantity"]');
  const cost = tr.querySelector('[name="estimated_cost"]');
  const totalCell = tr.querySelector(".total-cell");

  const recalc = () => totalCell.textContent = toMyanmarNumber((qty.value * cost.value).toLocaleString());
  qty.addEventListener("input", recalc);
  cost.addEventListener("input", recalc);

  tr.querySelector(".save-btn").addEventListener("click", async () => {
    const payload = {
      department: tr.querySelector('[name="department"]').value,
      item_name: esc(tr.querySelector('[name="item_name"]').value),
      category: esc(tr.querySelector('[name="category"]').value),
      quantity: parseInt(qty.value),
      unit: esc(tr.querySelector('[name="unit"]').value),
      estimated_cost: parseFloat(cost.value),
      month: tr.querySelector('[name="month"]').value,
      year: parseInt(tr.querySelector('[name="year"]').value),
      description: ""
    };

    const res = await fetch("{% url 'spending-list-api' %}", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
      body: JSON.stringify(payload)
    });

    if (res.ok) loadData();
    else alert("မအောင်မြင်ပါ");
  });
}


// department label map
const deptLabels = {
  office: "ရုံး",
  set: "SET",
  het: "HET",
  training: "School"
};


// APPEND SAVED ROW
function appendRow(r, idx) {
  const tr = document.createElement("tr");
  tr.className = "hover:bg-slate-50 dark:hover:bg-slate-800/50 transition";

  const deptLabel = deptLabels[r.department] || r.department;

  tr.innerHTML = `
    <td class="p-2 text-center">${toMyanmarNumber(idx)}</td>
    <td class="p-2 text-sm">${esc(r.item_name)}</td>
    <td class="p-2 text-sm">${esc(r.category)}</td>
    <td class="p-2 text-center">${esc(r.unit)}</td>
    <td class="p-2 text-center">${toMyanmarNumber(r.quantity)}</td>
    <td class="p-2 text-right">${toMyanmarNumber(r.estimated_cost)}</td>

    <td class="p-2 text-center">${esc(deptLabel)}</td>
    <td class="p-2 text-center">${toMyanmarMonth(r.month)}</td>
    <td class="p-2 text-center">${toMyanmarNumber(r.year)}</td>

    <td class="p-2 text-right">${toMyanmarNumber(r.total_cost)}</td>
    <td class="p-2 text-center space-x-2">
      <button class="text-blue-600 edit-btn">ပြင်မည်</button>
      <button class="text-red-600 delete-btn">ဖျက်မည်</button>
    </td>
  `;

  // DELETE
  tr.querySelector(".delete-btn").addEventListener("click", async () => {
    if (!confirm("ဖျက်မလား?")) return;

    await fetch(`{% url 'spending-list-api' %}${r.id}/`, {
      method: "DELETE",
      headers: { "X-CSRFToken": csrfToken }
    });

    loadData();
  });

  // EDIT
  tr.querySelector(".edit-btn").addEventListener("click", () => toEditMode(tr, r, idx));

  body.appendChild(tr);
}


// EDIT MODE
function toEditMode(tr, r, idx) {
  const deptSelect = Object.entries(deptLabels)
    .map(([v,l]) => `<option value="${esc(v)}" ${v===r.department?"selected":""}>${esc(l)}</option>`)
    .join("");

  const monthSelect = Object.entries(myanmarMonths)
    .map(([k,v]) => `<option value="${k}" ${k===r.month?"selected":""}>${esc(v)}</option>`)
    .join("");

  const currentYear = new Date().getFullYear();
  const yearOptions = Array.from({length:5},(_,i)=>currentYear-2+i)
    .map(y => `<option value="${y}" ${y==r.year?"selected":""}>${toMyanmarNumber(y)}</option>`)
    .join("");

  tr.innerHTML = `
    <td class="p-2 text-center">${toMyanmarNumber(idx)}</td>

    <td><input name="item_name" value="${esc(r.item_name)}" class="border dark:bg-slate-700 dark:text-white rounded px-2 py-1 w-full"></td>
    <td><input name="category" value="${esc(r.category)}" class="border dark:bg-slate-700 dark:text-white rounded px-2 py-1 w-full"></td>

    <td><input name="quantity" type="number" value="${r.quantity}" class="border dark:bg-slate-700 dark:text-white rounded w-20 text-center"></td>
    <td><input name="unit" value="${esc(r.unit)}" class="border dark:bg-slate-700 dark:text-white rounded w-20 text-center"></td>

    <td><input name="estimated_cost" type="number" value="${r.estimated_cost}" class="border dark:bg-slate-700 dark:text-white rounded w-28 text-right"></td>

    <td><select name="department" class="border dark:bg-slate-700 dark:text-white rounded px-2 py-1 w-full">${deptSelect}</select></td>
    <td><select name="month" class="border dark:bg-slate-700 dark:text-white rounded px-2 py-1 w-full">${monthSelect}</select></td>
    <td><select name="year" class="border dark:bg-slate-700 dark:text-white rounded px-2 py-1 w-full">${yearOptions}</select></td>

    <td class="text-right total-cell">${toMyanmarNumber(r.total_cost)}</td>

    <td class="text-center">
      <button class="bg-blue-600 text-white px-3 py-1 rounded update-btn">ပြုပြင်မည်</button>
      <button class="bg-gray-500 text-white px-3 py-1 rounded cancel-btn">မပြုပြင်ပါ</button>
    </td>
  `;

  const qty = tr.querySelector('[name="quantity"]');
  const cost = tr.querySelector('[name="estimated_cost"]');
  const totalCell = tr.querySelector(".total-cell");

  const recalc = () => totalCell.textContent = toMyanmarNumber((qty.value * cost.value).toLocaleString());
  qty.addEventListener("input", recalc);
  cost.addEventListener("input", recalc);

  tr.querySelector(".update-btn").addEventListener("click", async () => {
    const payload = {
      department: tr.querySelector('[name="department"]').value,
      month: tr.querySelector('[name="month"]').value,
      year: parseInt(tr.querySelector('[name="year"]').value),

      item_name: esc(tr.querySelector('[name="item_name"]').value),
      category: esc(tr.querySelector('[name="category"]').value),
      quantity: parseInt(qty.value),
      unit: esc(tr.querySelector('[name="unit"]').value),
      estimated_cost: parseFloat(cost.value)
    };

    await fetch(`{% url 'spending-list-api' %}${r.id}/`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
      body: JSON.stringify(payload)
    });

    loadData();
  });

  tr.querySelector(".cancel-btn").addEventListener("click", loadData);
}


// Filters + Export
monthSel.addEventListener("change", loadData);
yearSel.addEventListener("change", loadData);

document.getElementById("pdf-export").addEventListener("click", () => {
  const m = monthSel.value, y = yearSel.value;
  window.open(`{% url 'spending-export-pdf' %}?month=${m}&year=${y}`, "_blank");
});

// Init
document.addEventListener("DOMContentLoaded", loadData);
</script>



{% endblock %}
