{% extends "layouts/main.html" %}
{% block title %}Device Settings{% endblock %}

{% block content %}

<div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">

    <h2 class="text-2xl font-semibold text-slate-800 dark:text-slate-100 mb-6">
        Office Devices Management
    </h2>

    <!-- Hidden CSRF so JS can read it -->
    <form style="display:none;">{% csrf_token %}</form>

    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead>
                <tr class="bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300">
                    <th class="px-3 py-2 text-left">Device ID</th>
                    <th class="px-3 py-2 text-left">Label</th>
                    <th class="px-3 py-2 text-left">Allowed</th>
                    <th class="px-3 py-2 text-left">Last Seen</th>
                    <th class="px-3 py-2 text-left">Last IP</th>
                    <th class="px-3 py-2 text-left">User</th>
                    <th class="px-3 py-2 text-left">Action</th>
                </tr>
            </thead>

            <tbody>
                {% for d in devices %}
                <tr class="border-b border-slate-200 dark:border-slate-700">

                    <!-- Device ID -->
                    <td class="px-3 py-2 font-mono text-xs">{{ d.device_id }}</td>

                    <!-- Label (inline editable) -->
                    <td class="px-3 py-2">
                        <span class="label-text cursor-pointer underline decoration-dotted text-slate-700 dark:text-slate-200"
                              data-id="{{ d.id }}">
                            {{ d.label|default:"-" }}
                        </span>

                        <input type="text"
                               class="label-input hidden px-2 py-1 border rounded w-40 
                                      bg-white dark:bg-slate-800 
                                      text-slate-800 dark:text-slate-100 
                                      border-slate-300 dark:border-slate-600"
                               data-id="{{ d.id }}"
                               value="{{ d.label }}">
                    </td>

                    <!-- Allowed toggle -->
                    <!-- <td class="px-3 py-2">
                        <label class="inline-flex items-center cursor-pointer select-none">
    <input type="checkbox"
           class="toggle-allow sr-only peer"
           data-id="{{ d.id }}"
           {% if d.is_allowed %}checked{% endif %}>

    <div class="w-11 h-6 rounded-full bg-slate-300 dark:bg-slate-700 
                peer-checked:bg-green-500 peer-checked:dark:bg-green-600 
                relative transition">

        <div class="dot absolute top-1 left-1 w-4 h-4 bg-white rounded-full shadow 
                    transition-transform duration-300 
                    peer-checked:translate-x-5"></div>
    </div>
</label>

                    </td> -->

                    <td class="px-3 py-2">
    <label class="inline-flex items-center cursor-pointer">
        <input type="checkbox"
               class="toggle-allow hidden"
               data-id="{{ d.id }}"
               {% if d.is_allowed %}checked{% endif %}>

        <span class="toggle-bg w-11 h-6 flex items-center rounded-full p-1 duration-300 
                     bg-slate-300 dark:bg-slate-700">
            <span class="dot w-4 h-4 bg-white rounded-full shadow transform duration-300"></span>
        </span>
    </label>
</td>


                    <!-- Last seen -->
                    <td class="px-3 py-2">{{ d.last_seen|date:"Y-m-d H:i:s" }}</td>

                    <td class="px-3 py-2">{{ d.last_ip }}</td>
                    <td class="px-3 py-2">{{ d.last_user|default:"-" }}</td>

                    <td class="px-3 py-2">
                        <button data-id="{{ d.id }}" 
                                class="remove-btn px-3 py-1 bg-red-600 text-white rounded-lg text-xs hover:bg-red-700">
                            Remove
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", () => {
    const csrf = document.querySelector("[name=csrfmiddlewaretoken]").value;

    // ---------------------------------------------------------
    //  APPLY INITIAL SWITCH UI STATE
    // ---------------------------------------------------------
    document.querySelectorAll(".toggle-allow").forEach(input => {
        const bg = input.nextElementSibling;
        const dot = bg.querySelector(".dot");

        if (input.checked) {
            bg.classList.remove("bg-slate-300", "dark:bg-slate-700");
            bg.classList.add("bg-green-500", "dark:bg-green-600");
            dot.style.transform = "translateX(20px)";
        } else {
            bg.classList.remove("bg-green-500", "dark:bg-green-600");
            bg.classList.add("bg-slate-300", "dark:bg-slate-700");
            dot.style.transform = "translateX(0px)";
        }
    });

    // ---------------------------------------------------------
    //  TOGGLE SWITCH â€” AJAX + UI
    // ---------------------------------------------------------
    document.querySelectorAll(".toggle-allow").forEach(input => {
        input.addEventListener("change", () => {
            const id = input.dataset.id;
            const bg = input.nextElementSibling;
            const dot = bg.querySelector(".dot");

            // Backend update
            fetch(`/device/${id}/toggle-allow/`, {
                method: "POST",
                headers: { "X-CSRFToken": csrf }
            });

            // Update UI
            if (input.checked) {
                bg.classList.remove("bg-slate-300", "dark:bg-slate-700");
                bg.classList.add("bg-green-500", "dark:bg-green-600");
                dot.style.transform = "translateX(20px)";
            } else {
                bg.classList.remove("bg-green-500", "dark:bg-green-600");
                bg.classList.add("bg-slate-300", "dark:bg-slate-700");
                dot.style.transform = "translateX(0px)";
            }
        });
    });
});

</script>

{% endblock %}
